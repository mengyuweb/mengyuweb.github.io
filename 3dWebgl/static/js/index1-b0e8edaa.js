import{S as ke,aS as Oe,b as Le,M as z,c as ye,d as k,P as Te,X as v,W as ze,e as Fe,g as me,B as Re,V as Ie,L as Ue,f as He,E as ee,aA as We,al as Ne,h as Ve,i as Ye}from"./three.module-96598850.js";import{O as Xe}from"./OrbitControls-104f536d.js";import{t as $e,l as qe,f as Je,h as Ke,e as p,S as Qe,B as pe,E as Ze,R as eo,O as oo,a as ue,i as to,g as no,b as fe,j as so,k as ao,r as oe,n as ro,o as he,p as co,c as io,d as lo}from"./postprocessing.esm-da16e687.js";import{g as B}from"./index-9e2476f3.js";import{G as mo}from"./dat.gui.module-798d8523.js";import{g as po,a as uo,r as fo}from"./currency-1843da70.js";import{c as ho,r as go,s as ge}from"./separate-c4e7db7a.js";import{a as yo}from"./modifyCityMaterial-dcc2fbbe.js";import{u as wo}from"./index-c359eb9c.js";import{_ as bo}from"./breadcrumb.vue_vue_type_script_setup_true_lang-a8f45c07.js";import{d as xo,k as te,l as Co,L as vo,o as Eo,b as Po,i as U,g as So,F as jo,M as _o}from"./index-5de0d8c7.js";import"./CSS2DRenderer-bca6bf67.js";const a=new ke,Do=new Oe().setPath("/src/assets/img/texture/"),we=Do.load(["1.jpg","2.jpg","3.jpg","4.jpg","5.jpg","6.jpg"]);a.background=we;a.environment=we;const be=$e("./texture/shangsheng.png");be.offset.set(1,.5);const Go=new Le(2,10),Mo=new z({map:be,transparent:!0,side:ye}),Ao=new k(Go,Mo),Bo={class:"map_boxs"},ko={class:"breadcrumbs"},$o=xo({__name:"index1",setup(Oo){const H=te(null),ne=te(null),se=te(!0),ae=po(),re=uo();let F=qe();const O=wo(),{codeObj:xe}=p,Ce=O.mapAdcodeUserData,W=new mo;let h,R=p.panelColor;const y=new Te(45,ae/re,.1,1e3),E=new v,P=new v,I=new v,g=new v,N=new v,S=new v,b=new v;let j,_,D,V,Y={};const X=Je();y.position.set(30,20,60);const G=new ze;G.setSize(ae,re);const ce=new Xe(y,F.domElement),$={depth:.001,bevelEnabled:!1,bevelSize:0};ho(ce);const ve=()=>{V=new Qe(a,y,{mipmapBlur:!0,blendFunction:pe.ADD,luminanceThreshold:.7,luminanceSmoothing:.3,intensity:2}),j=new Ze(G),j.addPass(new eo(a,y)),_=new oo(a,y,{blendFunction:pe.ADD,edgeStrength:5,visibleEdgeColor:12434213,hiddenEdgeColor:12434213,xRay:!1});const o=new ue(y,_);j.addPass(o);const e=new to;let n=new ue(y,V,e);j.addPass(n)},Ee=(o,{centroid:e,level:n})=>{h=W.addFolder("地图地板自定义颜色"),D=fe().center(e).scale(ge(n)).translate([0,0]),o.forEach((s,r)=>{const{centroid:c,center:t,name:f,adcode:x}=s.properties;if(x==71e4||!f)return;let u=s.geometry.coordinates[0];const d=c||t;if(c||(s.properties.centroid=t),r==1||r==5||r==2){const i=D(d);s.properties.index=r,Se(i,s.properties)}else if(r==3){const i=D(d),m=2;so().then(l=>{l.position.set(i[0],p.depth+1.3,i[1]),l.scale.set(m,m,m),l.side=ye,B.to(l.position,{y:6,repeat:-1,duration:1,ease:"power1.imOut",yoyo:!0}),g.add(l);const M=ao({x:i[0],y:i[1]});g.add(M)})}u=u.length>1?[[...u]]:u,u.forEach(i=>{const m=new me,l=new Re,M=new Array;for(let A=0;A<i.length;A++){let[Q,Z]=D(i[A]);M.push(new Ie(Q,-Z,.3)),A===0&&m.moveTo(Q,-Z),m.lineTo(Q,-Z)}l.setFromPoints(M);const L=new Ue({color:oe()});let J=new He(l,L);I.add(J);const K=new ee(m,$),T=new z({color:p.panelColor,map:X}),C=new k(K,T);C.userData=s.properties,C.userData.color=p.panelColor,C.userData.activeColor=p.panelActiveColor,C.name=f,P.add(C)})}),E.add(P,I),E.rotation.x=p.rotationx,E.position.y=p.depth,q("")},Pe=(o,{centroid:e=[108.93,34.37],level:n=""})=>{D=fe().center(e).scale(ge(n)).translate([0,0]);const s={interval:{value:2}},{vertexShader:r,fragmentShader:c}=yo();o.forEach((x,u)=>{let d=x.geometry.coordinates[0];d=d.length>1?[[...d]]:d,d.forEach(i=>{const m=new me;for(let T=0;T<i.length;T++){let[C,A]=D(i[T]);m.lineTo(C,-A)}const l=new ee(m,{...$,depth:.4}),M=new z({transparent:!0,opacity:0}),L=new k(l,M);L.position.z=.1,_.selection.add(L);const J=new We({side:Ne,uniforms:s,vertexShader:r,fragmentShader:c}),K=new k(new ee(m,{...$,depth:-p.depth}),J);S.add(L,K)})}),S.rotation.x=p.rotationx,S.position.y=p.depth-.1;const t=.1;b.add(E),b.add(S),a.add(b),b.scale.set(t,t,t);const f=1;B.to(b.scale,{x:f,y:f,z:f,duration:2,ease:"back.out(3)",onComplete:()=>{if(console.log("动画放大完成"),a.add(g),a.add(N),h.addColor(p,"panelColor").name("地图面板颜色").onChange(function(u){P.children.forEach(d=>{d.material.color.set(u),R=u})}),h.add(X.offset,"x").name("地图面板图片x").min(0).max(1).step(.01),h.add(X.offset,"y").name("地图面板图片y").min(0).max(1).step(.01),se.value){const u=ro(h);a.add(...u);const d={imgs:"",color:"#1f2937"};let i=he(d);d.imgs||h.addColor(d,"color").name("地板背景颜色").onChange(function(l){i.material.color.set(l),console.log(l)}),a.add(i);const m={imgs:"",visibleEdgeColor:"#bdbb25",blur:!1};h.add(m,"imgs",{shanghai:"shanghai.png",biaomian:"biaomian.png",color:""}).name("是否渲染背景图").onChange(function(l){d.imgs=l,a.remove(i),i=he(d),a.add(i)}),h.addColor(m,"visibleEdgeColor").name("轮廓线颜色").onChange(function(l){console.log(l),_.visibleEdgeColor.set(l)}),h.add(m,"blur").name("轮线是否开启模糊").onChange(function(l){_.blur=l})}H.value.appendChild(F.domElement),B.to(g.position,{y:0,duration:2,ease:"power1.imOut"}),h.add(s.interval,"value",.2,6).name("地图外部垂直渐变").step(.1);const x={color1:"#fff"};h.addColor(x,"color1").name("柱子颜色").onChange(function(u){g.children[1].material.color.set(u)}),a.add(Ao)}})},q=async(o="_full")=>{const e=O.mapAdcodeUserData,n=e.adcode;console.log(n,e);const s=n?String(n):"100000",r=e.level=="district"?"":o,{features:c}=await no(s+r),t=n?e:xe[s];o?Ee(c,t):Pe(c,t)},Se=(o,e,n="")=>{const[s,r,c]=[...o,p.depth*2];e.index==2?g.add(co({x:s,y:p.depth+.6,z:r})):je([s,r],e);const t=fo(4,10);e.value=t,e.positiony=p.depth;const f=io({x:s,y:r,height:t,index:e.index});e.index!=2&&lo(f,e),g.add(f),g.position.y=-t,Y[e.adcode]=e},je=(o,e,n)=>{const[s,r,c]=[...o,p.depth+.6];e.adcode=="100000"?De([s,r,c]):_e([s,r,c])},_e=([o,e,n],s)=>{const r=new Ve(1,1.1,20),c=new z({color:oe()}),t=new k(r,c);t.position.set(o,n,e),t.rotation.x=p.rotationx;const f=2;g.add(t),B.to(t.scale,{x:f,y:f,z:f,duration:2,ease:"power1.imOut",yoyo:!0,delay:5,repeat:-1})},De=([o,e,n],s)=>{const r=new Ye(1,.2,10,100,6),c=new z({color:oe()}),t=new k(r,c);t.position.set(o,n,e),t.rotation.x=p.rotationx,_.selection.add(t),g.add(t),B.to(t.rotation,{z:10,repeat:-1,duration:10,delay:5,ease:"power1.inOut",yoyo:!0})};window.addEventListener("click",ie),document.addEventListener("mousemove",ie);let w=null;function ie(o){o.stopPropagation();const e=Ge(o),n=new Fe;n.setFromCamera(e,y);const s=n.intersectObjects(P.children,!0),r=ne.value;if(s.length>0){const c=s[0].object,t=c.userData;if(o.type=="click"){console.log(t);const{acroutesObj:f,adcode:x,name:u,center:d,centroid:i,level:m}=Ce;if(m=="district")return;u?O.setAdcode({...t,acroutesObj:{...f,[x]:{adcode:x,name:u,center:d,centroid:i,level:m}}}):O.setAdcode({...t,acroutesObj:{1e5:"中国"}}),le(r);return}w&&w.object.name!==c.name&&(w.object.material.color.set(R),w=null),w=s[0],c.name&&(Ke({...t,moodIds:r},o.clientX,o.clientY),c.material.color.set(t.activeColor),Y[c.userData.adcode]||(Y[c.userData.adcode]=c.userData))}else w&&w.object.name&&(console.log(w.object.material,R),w.object.material.color.set(R),w=null),le(r)}const le=o=>{o&&o.childNodes.length&&(o.innerHTML="")};function Ge(o){o.stopPropagation();let e={x:0,y:0};const n=G.domElement,s=Me(o,n);return e.x=s.x/n.width*2-1,e.y=s.y/n.height*-2+1,e}function Me(o,e){o.stopPropagation();const n=e.getBoundingClientRect();return{x:(o.clientX-n.left)*e.width/n.width,y:(o.clientY-n.top)*e.height/n.height}}const Ae=()=>{const o=document.getElementById("labelBoxs");o.innerHTML="",se.value=!1,g.children=[],N.children=[],S.children=[],a.remove(g),a.remove(N),a.remove(S),W.removeFolder(h);const e=.1;B.to(b.scale,{x:e,y:e,z:e,duration:1,ease:"power3.out",onComplete:()=>{P.children=[],I.children=[],E.children=[],b.children=[],console.log("动画缩小完成"),a.remove(P),a.remove(I),a.remove(E),a.remove(b),_o(()=>{y.position.set(30,20,60),q()})}})};O.$subscribe(()=>{Ae()}),(()=>{ve(),q(),de(),go(y,G,F)})(),Co(()=>{var o;(o=H.value)==null||o.appendChild(G.domElement)});const Be=()=>{if(a){for(a.traverse(function(o){});a.children.length>0;)a.remove(a.children[0]);G.dispose(),a.clear(),j.removePass(V),W.destroy()}};vo(()=>Be());function de(){requestAnimationFrame(de),ce.update(),j.render(),F.render(a,y)}return(o,e)=>(Eo(),Po(jo,null,[U("div",Bo,[U("div",ko,[So(bo)]),U("div",{ref_key:"mapId",ref:H,class:"map_box"},null,512)]),U("div",{ref_key:"mood_Id",ref:ne,class:"mood_box2"},null,512)],64))}});export{$o as default};
